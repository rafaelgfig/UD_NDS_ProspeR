Explorando e resumindo dados de empréstimos da Prosper por Rafael G. Figueira
========================================================
<p>Esse relatório explora um conjunto de dados de empréstimos da Prosper, possuindo 113.937 empréstimos com 81 variáveis em cada um, incluindo valor, taxa de juros, status do pagamento, receita do mutuário, seu emprego atual, histórico do cartão de crédito, informações sobre seu último pagamento, entre outras.</p>
```{r Librarys, echo=FALSE, message=FALSE, warning=FALSE}
# Carregamento das bibliotécas
library(dplyr)
library(gridExtra)
library(ggplot2)
library(tidyr)
library(purrr)
library(reshape2)
library(GGally)
```

```{r Read CSV, echo=FALSE}
# Carregamento dos dados
df <- read.csv('prosperLoanData.csv')
```

## Seção de Gráficos Univariados
<p>O conjunto de dados original possui 113937 linhas e 81 colunas.</p>
```{r Dimensao dos dados, echo=FALSE}
# Dimensão dos dados originais
dim(df)
```
<p>Foram escolhidas 15 variáveis julgadas mais interessantes para a minha análise.<br/> Sendo elas:</p>
* MemberKey
* LoanKey
* Term
* LoanStatus
* BorrowerAPR
* BorrowerRate
* ProsperScore
* ListingCategory..numeric.
* Occupation
* EmploymentStatus
* EmploymentStatusDuration
* StatedMonthlyIncome
* LoanOriginalAmount
* LoanOriginationDate
* MonthlyLoanPayment

Abaixo seguem algumas informações úteis sobre os dados.<br/>
```{r Selecionado colunas de interesse, echo=FALSE}
# Selecionando algumas colunas de interesse
dff <- (subset(df, select = c('MemberKey',
                              'LoanKey',
                              'Term',
                              'LoanStatus',
                              'BorrowerAPR',
                              'BorrowerRate',
                              'ProsperScore',
                              'ListingCategory..numeric.',
                              'Occupation',
                              'EmploymentStatus',
                              'EmploymentStatusDuration',
                              'StatedMonthlyIncome',
                              'LoanOriginalAmount',
                              'LoanOriginationDate',
                              'MonthlyLoanPayment')
            )
     )
```


```{r Tipos dos dados, echo=FALSE}
# Colunas e tipos de dados
str(dff)
```

```{r Resumo estatistico, echo=FALSE}
# Resumo estatístico
summary(dff)
```
<br/>Quantidade de NA's:
```{r Verificando quantidade de NAs, echo=FALSE}
# Verificando quantidade de NA's
colSums(is.na(dff))
```

Visualizando distribuição das variáveis selecionadas.<br/>
```{r Histograma basico das colunas, echo=FALSE, fig.height=12, message=FALSE, warning=FALSE}
# Histograma básico das colunas
dff %>%
  keep(is.numeric) %>%
  gather() %>%
  ggplot(aes(value)) +
    facet_wrap(~key, scales = 'free', ncol = 1) +
    geom_histogram()
```

<p>É possível ver que o histograma da variável *StatedMonthlyIncome* está totalmente concentrado em zero.</p>
Analizando o resumo estatístico é possível ver que a variável contém alguns dados discrepantes.
```{r Resumo estatistico StatedMonthlyIncome, echo=FALSE}
# Verificando que plotagem da renda mensal está enviesada por conta de outlier
summary(dff$StatedMonthlyIncome)
```

<p>Os 10 valores mais altos da variável são:</p>
```{r Top 10 StatedMonthlyIncome, echo=FALSE}
# Visualizando as 10 maiores rendas declaradas
sort(tail(sort(dff$StatedMonthlyIncome), 10), decreasing = T)
```

<p>Visualizando os dados sem 0.5% dos maiores valores.</p>
```{r Histograma StatedMonthlyIncome sem 0.5 porcento, echo=FALSE, message=FALSE, warning=FALSE}
# Plotagem removendo 0.5% das maiores rendas
ggplot(dff, aes(x = StatedMonthlyIncome)) +
  geom_histogram(binwidth = 250) +
  scale_x_continuous(limits = c(0, quantile(dff$StatedMonthlyIncome, .995)))
```

<p>Omitindo 5% dos maiores valores:</p>
```{r Histograma StatedMonthlyIncome sem 5 porcento, echo=FALSE, message=FALSE, warning=FALSE}
# Plotagem removendo 5% das maiores rendas
ggplot(dff, aes(x = StatedMonthlyIncome)) +
  geom_histogram(binwidth = 250, color = 'black') +
  scale_x_continuous(limits = c(0, quantile(dff$StatedMonthlyIncome, .95)),
                     breaks = seq(0, 12500, 1000))
```

Nos gráficos abaixo podemos ver que a maioria dos empréstimo possuem valores arredondados, dando ênfase para empréstimos de 4.000, os posteriores tendem a ser múltiplos de 5.000.<br/>
```{r Histogramas LoanOriginalAmount, echo=FALSE, message=FALSE, warning=FALSE}
# Distribuição dos dados da coluna LoanOriginalAmount
g <- ggplot(df, aes(x = LoanOriginalAmount)) +
  scale_x_continuous(breaks = seq(0, max(df$LoanOriginalAmount), 5000))
g1 <- g + geom_histogram(binwidth = 1000)
g2 <- g + geom_histogram(binwidth = 500)
g3 <- g + geom_histogram(binwidth = 250)
grid.arrange(g1, g2, g3, ncol = 1)
```

<p>Abaixo é possível observar que é mais comum encontrar pessoas com poucos meses de emprego solicitando empréstimo do que em comparação com aqueles com muito tempo.</p>
Tempo em meses:<br/>
```{r Histograma EmploymentStatusDuration sem 5 porcento, echo=FALSE, message=FALSE, warning=FALSE}
# Distribuição do tempo de emprego omitindo 5%
ggplot(subset(dff, !is.na(EmploymentStatusDuration)), aes(x = EmploymentStatusDuration)) +
  geom_histogram(binwidth = 1) +
  scale_x_continuous(limits = c(0, quantile(dff$EmploymentStatusDuration, .95, na.rm = T)),
                     breaks = seq(0, 300, 25))
```

Tempo em anos:<br/>
```{r Histograma EmploymentStatusDuration sem 5 porcento em anos, echo=FALSE, message=FALSE, warning=FALSE}
# Distribuição do tempo de emprego em anos omitindo 5%
ggplot(subset(dff, !is.na(EmploymentStatusDuration)), aes(x = floor(EmploymentStatusDuration/12))) +
  geom_histogram(binwidth = 1, color = 'black') +
  scale_x_continuous(limits = c(0, quantile(dff$EmploymentStatusDuration/12, .95, na.rm = T)),
                     breaks = seq(0, 25, 1))
```

Distribuição dos status do emprego:<br/>
```{r Distribuicao EmploymentStatus, echo=FALSE, message=FALSE, warning=FALSE}
# Distribuição dos status do emprego
ggplot(subset(dff, EmploymentStatus != ''), aes(x = reorder(EmploymentStatus, -table(EmploymentStatus)[EmploymentStatus]))) +
  geom_bar() +
  xlab('EmploymentStatus')
```
```{r Porcentagem EmploymentStatus desempregado, echo=FALSE, message=FALSE, warning=FALSE}
# Porcentagem de mutuários declaradamente sem emprego
round(sum(dff$EmploymentStatus == 'Not employed')/length(dff$EmploymentStatus),digits = 3)*100
```
A grande maioria dos solicitantes de empréstimos está atualmente empregado de alguma forma. Apenas 0.7% dos mutuários são declaradamente desempregados.

<br/>
O histograma da duração do empréstimo ficou muito espaçado por conta da coluna estar como tipo de valor inteiro, e como só há 3 variações de duração (12, 36 ou 60) dentro dessa coluna, é possível assumí-la como dado categórico e plotar como tal. <br/>
```{r Alterado Term para categorico e plotado, echo=FALSE, fig.height=4, fig.width=2, message=FALSE, warning=FALSE}
# Alterando variável para o tipo categórica, já que só há 3 tipos de valores
dff$Term <- factor(dff$Term)
# Distribuição da duração do empréstimo
ggplot(dff, aes(x = Term)) + 
  geom_bar()
```

<br/>
Categorias mais selecionadas pelo mutuário:<br/>
```{r Alterado ListingCategory para categorico e plotado, echo=FALSE, fig.height=3, message=FALSE, warning=FALSE}
# Alterando variável ListingCategory..numeric. para categórica
dff$ListingCategory..numeric. <- factor(dff$ListingCategory..numeric.)
# Distribuição dos status do emprego
ggplot(dff, aes(x = reorder(ListingCategory..numeric., -table(ListingCategory..numeric.)[ListingCategory..numeric.]))) +
  geom_bar(width = .8) +
  scale_y_continuous(breaks = scales::trans_breaks('log10', function(x) 10^x),
                     labels = scales::trans_format('log10', scales::math_format(10^.x)),
                     trans = 'log10')+
  xlab('ListingCategory')
```
<br/> Legenda das categorias:

0. Não disponível
1. Consolidação da dívida
2. Melhoria da casa
3. Negócios
4. Empréstimo pessoal
5. Uso do aluno
6. Automático
7. Outros 
8. Bebê e Adoção
9. Barco
10. Procedimento Cosmético
11. Anel de Noivado
12. Empréstimos Verdes
13. Gastos Domésticos
14. Grandes Compras
15. Médico / Odontológico
16. Motocicleta
17. VD
18. Impostos
19. Férias
20. Empréstimos do casamento

<p/>
<br/>
Distribuição das ocupações declaradas:<br/>
```{r Distribuição Occupation, echo=FALSE, fig.height=20, message=FALSE, warning=FALSE}
# Distribuição dos status do emprego
ggplot(dff, aes(x = reorder(Occupation, +table(Occupation)[Occupation]))) +
  geom_bar() +
  xlab('Occupation') +
#  scale_y_log10() +
  coord_flip()
```
<br/>A grande maioria declarou como "Outra" a ocupação ou declarou apenas como ocupação profissional, não sendo possível afirmar corretamente qual a ocupação mais comum. Das ocupações especificamente declaradas o programador de computador ficou em destaque.

<br/>
Distribuição dos valores das parcelas:<br/>
```{r Histogramas MonthlyLoanPayment, echo=FALSE, fig.height=12, message=FALSE, warning=FALSE}
# Distribuição das parcelas
g <- ggplot(dff, aes(x = MonthlyLoanPayment)) +
  scale_x_continuous(limits = c(0, quantile(dff$MonthlyLoanPayment, .99)),
                     breaks = seq(25, 1000, 50))
g1 <- g + geom_histogram(binwidth = 25, color='black')
g2 <- g + geom_histogram(binwidth = 10, color='black')
g3 <- g + geom_histogram(binwidth = 5)
g4 <- g + geom_histogram(binwidth = 1)

grid.arrange(g1, g2, g3, g4, ncol = 1)
```
<br/> Vemos uma frequência altíssima de mutuários com valor de parcela próximo da casa dos 175, mas pelo gráfico não é possível ter muita precisão, por mais que seja determinado 1 de binwidth.
```{r Top 3 MonthlyLoanPayment, echo=FALSE, message=FALSE, warning=FALSE}
# Valor com maior ocorrência no conjunto de dados
head(sort(table(dff$MonthlyLoanPayment),decreasing = T), 3)
```
```{r Porcentagem da parcela 173.71, echo=FALSE, message=FALSE, warning=FALSE}
round(sum(dff$MonthlyLoanPayment == 173.71) / length(dff$MonthlyLoanPayment) * 100, 2)
```
Verificado que 2423 parcelas de mutuários têm exatamente 173.71 como valor. Representando 2.13% de todos os dados.

```{r Resumo estatistico das parcelas 173.71, echo=FALSE, message=FALSE, warning=FALSE}
# Verificando os dados com parcela de 173.71
#names(dff)
subset(dff, MonthlyLoanPayment == 173.71) %>% 
  select(MemberKey, Term, LoanOriginalAmount, MonthlyLoanPayment, BorrowerAPR, ProsperScore) %>%
  summary()
```
Todos aqueles que solicitaram empréstimo de 4.000 para ser pago em 36 meses com APR de 0.358 tem o mesmo valor de parcela.<br/>
Foi verificado anteiormente que o valor mais solicitado é de 4.000 e a duração mais popular também é a de 36 meses, justificando a concentração anormal do valor da parcela com essa APR.

<br/>
Foi verificado também alguns empréstimos com pagamento mensal programado com valor zerado, podendo ser erro no conjunto de dados ou existe a possibilidade do mutuário simplesmente não programar um valor para o pagamento mensal, obtendo assim o valor zero.<br/>
Nesse caso foi considerado a segunda possibilidade e os dados foram mantidos.
```{r Resumo estatistico das parcelas 0, echo=FALSE, message=FALSE, warning=FALSE}
# Verificando os dados com parcela de 0
#names(dff)
subset(dff, MonthlyLoanPayment == 0) %>% 
  select(MemberKey, Term, LoanOriginalAmount, MonthlyLoanPayment, BorrowerAPR, ProsperScore) %>%
  summary()
```

```{r Alterado LoanOriginationDate para data e plotado, echo=FALSE, message=FALSE, warning=FALSE}
# Convertendo a variável cronológica em data
dff$LoanOriginationDate <- as.Date(dff$LoanOriginationDate)
# Distribuição dos dados cronológicos
ggplot(dff, aes(x = LoanOriginationDate)) + 
  geom_histogram(binwidth = 30, color='black') +
  scale_x_date(breaks = '1 year', date_labels = '%Y')
```
<br/>Ocorreu um aumento considerável de empréstimo a partir de 2013 e por alguma razão não há registros no começo de 2009 e final de 2008.

# Análise Univariada

### Qual é a estrutura do conjunto de dados?
São 113.937 empréstimos com 81 variáveis em cada um.<br/>
Visando uma exploração mais sucinta, foram escolhidas 15 variáveis de interesse, sendo elas:

* Duas variáveis identificadoras (MemberKey e LoanKey);
* Sete variáveis numéricas (BorrowerAPR, BorrowerRate, ProsperScore, EmploymentStatusDuration, StatedMonthlyIncome, LoanOriginalAmount e MonthlyLoanPayment);
* Uma variável cronológica (LoanOriginationDate);
* E cinco variáveis categóricas (Term, LoanStatus, ListingCategory..numeric., Occupation e EmploymentStatus)

A variável *ListingCategory..numeric.* está representada numéricamente, com a seguinte relação:

0. Não disponível
1. Consolidação da dívida
2. Melhoria da casa
3. Negócios
4. Empréstimo pessoal
5. Uso do aluno
6. Automático
7. Outros 
8. Bebê e Adoção
9. Barco
10. Procedimento Cosmético
11. Anel de Noivado
12. Empréstimos Verdes
13. Gastos Domésticos
14. Grandes Compras
15. Médico / Odontológico
16. Motocicleta
17. VD
18. Impostos
19. Férias
20. Empréstimos do casamento

Outras observações:

* A maioria dos empréstimos solicitados são de menos de 12000.
* Menos de 0.5% dos mutuários têm renda mensal acima de 25000, o mais comum é ganharem de 3200 a 6800.
* Normalmente os valores solicitados são múltiplos de 5000, com exceção aos empréstimos de 4000 que são os mais numerosos.
* Existem mutuários empregados por mais de 62 anos e os que não estão empregados. Em média estão 8 anos empregados.
* Apenas 0.7% dos mutuários são declaradamente desempregados.
* A duração do empréstimo mais solicitada é de 36 meses, em seguida de 60 meses e muito raramente 12 meses.
* Não há registros de empréstimos no final de 2008 e começo de 2009.

### Quais são os principais atributos de interesse deste conjunto de dados?
Os principais atributos de interesse são o montante original do empréstimo, renda declarada e razão pela qual solicitou o empréstimo. Quero entender quais são os perfís mais comuns de mutuários e suas motivações para solicitar os respectivos valores. Imagino que há uma correlação positiva de valor solicitado com a renda declarada ou talvez tempo de serviço.

### Quais outros atributos você acha que podem lhe auxiliar na investigação destes atributos de interesse?
Acho que todos os atributos selecionados apresentam certa importância, talvez as taxas de juros nem tanto, mas os demais certamente possuem valor para a análise, por conta disso que foram selecionados dentre os 81 possíveis.

### Você criou novas variáveis a partir dos atributos existentes no conjunto de dados?
Por enquanto, não.

### Dos atributos investigados, distribuições incomuns foram encontradas? Você aplicou operações nos dados para limpá-los, ajustá-los ou mudar a forma dos dados? Se sim, por quê?
<p>As distribuições das variáveis *EmploymentStatusDuration*, *MonthlyLoanPayment* e *StatedMonthlyIncome* são assimétricas positivas com longas caudas.</p>
<p>Para *StatedMonthlyIncome* só foram omitidos os valores mais altos (0.5% à 5%) para que a distribuição ficasse mais normal. Na análise bivariada foram removidos os 0.5% por distorcer muito as correlações e dispersões.</p>
<p>A *MonthlyLoanPayment* mesmo omitido os valores mais altos ainda continua bastante assimétrica, ainda assim não achei necessário redimenssioná-la, já que estava interessado em ver a concentração incomum dos dados próximos ao 175.</p>
<p>Já *EmploymentStatusDuration* é uma distribuição totalmente assimétrica positivamente. Com uma escala logarítmica ou de raiz ela normalizaria, mas não julguei necessário normalizá-la, apenas omiti 5% dos maiores valores para conseguir visualizar melhor os dados, e por ser um dado de tempo preferi que cada coluna representasse 1 mês ou 1 ano.<p/>
<p>Na *ListingCategory* há uma grande concentração dos dados da categoria 1, seguida da 0 e 7, ficando muito assimétrica a direita. Nessa distribuição foi usada uma escala logarítmica com base 10 no eixo *Y* para visualizar melhor os dados. Por mais que eles tenham se aproximado, a distribuição ainda segue assimétrica, uma vez que foi escalonado o eixo *Y* e não o *X*, já que está sendo contado os dados categóricos e não numéricos de fato.</p>
<p>Os dados da *LoanOriginationDate* criam duas distribuições assimétricas negativamente por conta de terem dados faltantes em certo período, ainda que houvessem esses dados a distribuição certamente permaneceria assimétrica para a esquerda. Nesse caso também não foi escalonado por se tratar de dados cronológicos, então preferi manter a escala normal para visualizar melhor.

# Seção de Gráficos Bivariados
```{r Removido 0.5 porcento do StatedMonthlyIncome e criado heatmap de corr, echo=FALSE}
# Removendo os 0.5% de outlier do StatedMonthlyIncome
dff <- subset(dff, StatedMonthlyIncome <= quantile(dff$StatedMonthlyIncome, .995))
# Selecionando variáveis numéricas
dff.numeric <- na.omit(subset(dff, select = c('BorrowerAPR',
                                              'ProsperScore',
                                              'EmploymentStatusDuration',
                                              'StatedMonthlyIncome',
                                              'LoanOriginalAmount',
                                              'MonthlyLoanPayment'
                                              )
                              )
                       )
# Criado matrix de correlação e remodelando os dados
melted <- melt(round(cor(dff.numeric), 2))
# Heatmap da correção
ggplot(melted, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile(colour = 'white') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title = element_blank()) +
  geom_text(aes(label = value))
```

Vemos que a *taxa APR* se relaciona com as demais colunas, salvo o *tempo empregado*. Ao que tudo indica, quanto maior o *Score*, menores são as *taxas APR*, e o mesmo ocorre com o *valor original do empréstimo*.

Assim como a *taxa APR*, o *Score* se relaciona com as demais, salvo o *tempo empregado*, mas no caso do *Score*, apenas a relação com a *taxa APR* que é negativa, o restante é positiva, por mais que sejam fracas, possivelmente uma é usada para a criação da outra.

O *valor original do empréstimo* tem forte relação com o *valor pago mensalmente*, uma vez que quanto maior o valor solicitado, maior será o valor da parcela, uma é praticamente derivada da outra.

Por fim o *tempo empregado* não se relaciona com praticamente nenhum das demais, apenas possuindo uma relação muito fraca com a *renda declarada*.

```{r Pairsplot das variaveis numericas, echo=FALSE, fig.height=12, fig.width=12, message=FALSE, warning=FALSE}
# Visão geral das variáveis numéricas
ggpairs(dff.numeric)
```

Os gráficos de dispersão estão em geral bem poluídos, menos do valor original do empréstimo com o valor pago mensalmente por terem forte correlação.<br/> É necessário olhar mais de perto para tentar entender as relações.

```{r Densidade LoanOriginalAmount por Score, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=12}
# Gráficos de dispersão do LoanOriginalAmount pelo ProsperScore
cc <- scales::seq_gradient_pal('red','green')(seq(0,1, length.out = 11))
ggplot(dff.numeric, aes(x = LoanOriginalAmount, fill = factor(ProsperScore))) +
  geom_density(kernel = 'gaussian') +
  scale_y_continuous(trans = 'sqrt', breaks = c(10, 100, 500, 1000, 2000, 3000)) +
  #scale_x_log10() +
  facet_wrap(~ProsperScore) +
  scale_fill_manual(values = cc)
```
<br/>

```{r Boxplot LoanOriginalAmount por Score, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=12}
# Boxplot LoanOriginalAmount pelo ProsperScore
ggplot(dff.numeric, aes(x = factor(ProsperScore), y = LoanOriginalAmount, fill = factor(ProsperScore))) +
  geom_boxplot() +
  scale_fill_manual(values = cc)
```
<br/> Com os gráficos de densidade e boxplot é possível ver com mais clareza a relação do Score com o valor original do empréstimo. <br/>
Mutuários com pouca pontuação dificilmente conseguem solicitar empréstimos com valores mais altos, se concentrando nos valores mais baixos, na medida que a pontuação aumenta, a distribuição fica mais uniforme, indicando que mutuários com alto Score conseguem solicitar com mais facilidade valores altos. Por mais que o valor mediano oscile, é possível observar que a maioria dos valores solicitados cresce junto ao Score.

```{r Boxplot LoanOriginalAmount por EmploymentStatus, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=12}
# Boxplot LoanOriginalAmount pelo EmploymentStatus
ggplot(dff, aes(x = reorder(EmploymentStatus, LoanOriginalAmount, function(x) -mean(x)), y = LoanOriginalAmount)) +
  geom_boxplot() 
```
<br/> Como esperado pessoas empregadas tendem a ter maiores valores de empréstimo, já as aposentadas, desempregadas, não declaradas e que trabalham parcialmente, tendem a ter empréstimos menores.

<br/>
```{r Dispersao LoanOriginalAmount por BorrowerAPR, echo=FALSE, message=FALSE, warning=FALSE}
# Resumo estatístico LoanOriginalAmount pelo BorrowerAPR
ggplot(dff.numeric, aes(x = BorrowerAPR, y = LoanOriginalAmount)) +
  geom_point(alpha = 1/20)
```
<br/> Empréstimos mais altos normalmente tem taxa APR menor, acho que ninguém quer pedir um valor alto com altas taxas ainda.

```{r Dispersao ProsperScore por BorrowerAPR, echo=FALSE, message=FALSE, warning=FALSE}
# Dispersao ProsperScore pelo BorrowerAPR
ggplot(dff.numeric, aes(x = ProsperScore, y = BorrowerAPR, color = factor(ProsperScore))) +
  geom_count() +
  scale_color_manual(values = cc)
```
```{r Boxplot ProsperScore por BorrowerAPR, echo=FALSE, message=FALSE, warning=FALSE}
# Boxplot ProsperScore pelo BorrowerAPR
ggplot(dff.numeric, aes(x = factor(ProsperScore), y = BorrowerAPR, fill = factor(ProsperScore))) +
  geom_boxplot() +
  scale_fill_manual(values = cc)
```
<br/> A correlação entre a taxa APR e o Score fica clara no boxplot, mutuários com baixa pontuação precisam de taxas maiores para compensar o risco do empréstimo, o que não ocorre com quem tem alta pontuação, obtendo assim as melhores taxas.  

```{r Dispersao StatedMonthlyIncome por LoanOriginalAmount, echo=FALSE, message=FALSE, warning=FALSE}
# Dispersão StatedMonthlyIncome por LoanOriginalAmount
ggplot(dff, aes(x = StatedMonthlyIncome, y = LoanOriginalAmount)) +
  geom_point(alpha = 1/10)
```

```{r Boxplot StatedMonthlyIncome por LoanOriginalAmount, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=12}
# Criação do bucket
dff$StatedMonthlyIncome.bucket <- cut(dff$StatedMonthlyIncome/1000,breaks = seq(0, 25, 2.5))
# Boxplot StatedMonthlyIncome.bucket por LoanOriginalAmount
cc2 <- scales::seq_gradient_pal('light green','dark green')(seq(0,1, length.out = length(levels(dff$StatedMonthlyIncome.bucket))))
ggplot(subset(dff, !is.na(StatedMonthlyIncome.bucket)), aes(x = StatedMonthlyIncome.bucket, y = LoanOriginalAmount, fill = StatedMonthlyIncome.bucket)) +
  geom_boxplot() +
  scale_fill_manual(values = cc2)
```

```{r Resumo estatistico StatedMonthlyIncome por LoanOriginalAmount, echo=FALSE, message=FALSE, warning=FALSE}
# Resumo estatístico
by(dff$LoanOriginalAmount, dff$StatedMonthlyIncome.bucket, summary)
```
<br/> Com o gráfico de dispersão é possível ver a correlação entre a renda declarada e o valor do empréstimo, mas ainda é muito poluido, por conta disso optei pelo boxplot com fatiamento de 2.500 das rendas, assim ficou muito mais claro a relação das duas e como rendas baixas de fato têm em sua maioria empréstimos menores.

Através dos resumos estatísticos observamos que rendas inferiores à 7.500 realizaram empréstimos de no máximo 25.000. A média também vai aumentando gradativamente conforme a renda sobe, demonstrando assim a relação entre as duas variáveis.

```{r Distribuicao EmploymentStatusDuration por StatedMonthlyIncome, echo=FALSE, message=FALSE, warning=FALSE}
# Scatterplot do tempo de serviço para o salário
ggplot(dff, aes(x = EmploymentStatusDuration/12, y = StatedMonthlyIncome)) +
  geom_point(alpha = 1/20) +
  coord_flip() +
  scale_y_continuous(breaks = seq(0, 25000, 2500))
```
<br/> Achei que houvesse uma leve correlação entre o tempo de serviço e a renda mensal, mas vendo a dispersão desses dados não parece haver. <br/>
A correlação de Pearson entre as duas variáveis resultou em 0.11, o que já seria bem fraco, agora com o gráfico é visível que o tempo de serviço não se relaciona com ela.

```{r Boxplot ListingCategory..numeric. por LoanOriginalAmount COUNT, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=12}
# Boxplot com numero de observações das categorias declaradas pelo valor do empréstimo
ggplot(dff, aes(x = ListingCategory..numeric., y = LoanOriginalAmount)) +
  geom_boxplot() +
  stat_summary(fun.y = function(y) ( median(y) + quantile(y, .75) ) / 2,
               geom = 'text',
               label = as.vector( table(dff$ListingCategory..numeric.) )
               )
```
<br/> Vemos que algumas categorias contêm empréstimos menores do que outras, como por exemplo a 13 (gastos domésticos) em comparação com a 1 (consolidação de dívida). Empréstimos com procedimentos cosméticos (número 10) além de serem poucos, não ultrapassam 15 mil.

```{r Boxplot Occupation por LoanOriginalAmount, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=6}
# Boxplot horizontal Occupation por LoanOriginalAmount
ggplot(dff, aes(x = reorder(Occupation, LoanOriginalAmount, function(x) +median(x)), y = LoanOriginalAmount)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 0)) +
  coord_flip() +
  scale_y_continuous(position = 'right', breaks = seq(0, 35000, 5000))
```

```{r Boxplot Occupation por StatedMonthlyIncome, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=6}
# Boxplot horizontal Occupation por StatedMonthlyIncome
ggplot(dff, aes(x = reorder(Occupation, StatedMonthlyIncome, function(x) +median(x)), y = StatedMonthlyIncome)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 0)) +
  coord_flip() +
  scale_y_continuous(position = 'right', breaks = seq(0, 25000, 5000))
```
<br/> Fiquei curioso quanto a distribuição de salários e valor do empréstimo solicitado das profissões declaradas.<br/>
Como demonstrado acima, pessoas que ganham mais tendem a solicitar um valor maior de empréstimo, e agora podemos ver também que estudantes normalmente são os que têm as menores rendas mensais e consequentemente os menores empréstimos.

```{r Dispersao LoanOriginationDate por LoanOriginalAmount, echo=FALSE, message=FALSE, warning=FALSE}
# Dispersao de LoanOriginationDate por LoanOriginalAmount
ggplot(dff, aes(x = LoanOriginationDate, y = LoanOriginalAmount)) +
  geom_point(alpha = 1/20) +
  scale_x_date(breaks = '1 year', date_labels = '%Y') +
  scale_y_continuous(breaks = seq(0, 35000, 5000))
```
```{r Diespersao LoanOriginationDate por LoanOriginalAmount c corte alto, echo=FALSE, message=FALSE, warning=FALSE}
# Dispersao do LoanOriginationDate por LoanOriginalAmount c corte alto
ggplot(dff, aes(x = LoanOriginationDate, y = LoanOriginalAmount)) +
  geom_point(alpha = 1/3) +
  scale_x_date(breaks = '1 year', date_labels = '%Y') +
  scale_y_continuous(limits = c(25000, 35000), breaks = seq(25000, 35000, 1000))
```
```{r Dispersao LoanOriginationDate por LoanOriginalAmount c corte baixo, echo=FALSE, message=FALSE, warning=FALSE}
# Dispersao de LoanOriginationDate por LoanOriginalAmount c corte baixo
ggplot(dff, aes(x = LoanOriginationDate, y = LoanOriginalAmount)) +
  geom_point(alpha = 1/10) +
  scale_x_date(breaks = '1 year', date_labels = '%Y') +
  scale_y_continuous(limits = c(1000, 4000), breaks = seq(1000, 4000, 500))
```
<br/> Vemos que o tempo não é um fator determinante para o valor do empréstimo, todavia, a partir de 2011 não foram mais realizados empréstimos menores que 2000, e somente depois de 2013 que foram realizados empréstimos acima de 25000.<br/> 
É interessante visualizar as linhas horizontais, demonstrando que realizam mais empréstimos com valores redondos do que quebrados, nesse caso sendo mais comum de 500 em 500. <br>
Além disso ainda é ver novamente o período curiosiamente sem empréstimos.

```{r Boxplot LoanOriginalAmount por Term, echo=FALSE, message=FALSE, warning=FALSE}
# Boxplot de LoanOriginalAmount por Term
ggplot(dff, aes(x = Term, y = LoanOriginalAmount)) +
  geom_boxplot()
```
<br/> Por último um boxplot da quantidade de parcelas com o valor solicitado para confirmar que mais parcelas são para os empréstimos maiores e o inverso para empréstimos menores.

# Análise Bivariada

### Discuta sobre alguns dos relacionamentos observados nesta parte da investigação. Como os atributos de interesse variaram no conjunto de dados?
Um dos pontos mais importante - se não o mais importante - é a pontuaçao do mutuário. Mutuários com alta pontuação conseguem empréstimos com menores juros, e menores juros possibilitam empréstimos maiores.

Pessoas com rendas maiores tendem a ter empréstimos maiores, assim como pessoas desempregadas, apostentadas ou com trabalho parcial tendem a ter empréstimos menores, isso é algo intuitivo, mas que se mostrou ser verdade através da análise gráfica.

Os estudantes são os que conseguem os menores empréstimos, porque também são os que têm as menores rendas. Vida de estudante não é fácil.

Existe um furo nos dados ao redor do começo de 2009 em que não foram realizados empréstimos, mas não sei se é um erro dos dados ou um período sem operação da empresa. Ademais, a partir de 2011 a Prosper não realizou mais empréstimos abaixo de 2.000 e foi só depois de 2013 que foram realizados empréstimos acima de 25.000, talvez a demanda tenha sido grande a ponto deles possibilitarem tais valores.

Achava que o tempo empregado iria se relacionar com alguma outra variável, mas analisando graficamente e pela correlação de pearson, o tempo de serviço não tem peso para entender os perfis dos mutuários.

### Você observou algum relacionamento interessante entre os outros atributos (os que não são de interesse)?
Não tinha tanto interesse nas taxas do empréstimo, mas foi demonstrado que ela se relaciona bem com as outras variáveis, o que faz sentido, uma vez que os mutuários não vão solicitar grandes empréstimos com altas taxas, a tendencia é que se tiverem boas taxas eles vão solicitar valores maiores.

### Qual foi o relacionamento mais forte encontrado?
O relacionamento mais forte - tirando é claro o valor das parcelas com o valor do empréstimo - foi o da pontuação com as taxas APR. Entendo que pessoas com baixa pontuação são um investimento mais arriscado, o que acaba elevando as taxas para compensar o risco, o que não ocorre com pessoas de alta pontuação. Pessoas com 11 de pontuação conseguem empréstimos com taxas de 0.1, enquanto que os que tem 1 de pontuação conseguem empréstimos na faixa de 0.35 de taxa.

# Seção de Gráficos Multivariados

```{r Distribuicao LoanAmount APR e Score, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=10}
# Scatterplot do valor do empréstimo pelas taxas com coloração do score
cc <- scales::seq_gradient_pal('red','green')(seq(0,1, length.out = 11))
ggplot(subset(dff, !is.na(ProsperScore)), aes(x = LoanOriginalAmount, y = BorrowerAPR, color = factor(ProsperScore))) +
  geom_point(shape = 18) +
  scale_color_manual(values = cc) +
  theme_dark()
```
<br/>Podemos ver a distribuição do Score baixo nas taxas mais altas, enquanto que no eixo do valor isso não ocorre, mas na medida que os juros ficam mais altos, o valor tende a diminuir.

```{r Distribuicao LoanAmount APR e MonthlyIncome, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=10}
# Scatterplot do valor do empréstimo pelas taxas com coloração da renda
cc2 <- scales::seq_gradient_pal('light green','black')(seq(0,1, length.out = length(levels(dff$StatedMonthlyIncome.bucket))))
ggplot(subset(dff, !is.na(StatedMonthlyIncome.bucket)), aes(x = LoanOriginalAmount, y = BorrowerAPR, color = StatedMonthlyIncome.bucket)) +
  geom_point(alpha = 1/2, shape = 18) +
  scale_color_manual(values = cc2) +
  theme_dark()
```
<br/>Interessante visualizar que pessoas com rendas altas não necessariamente solicitam empréstimos altos, mas as com rendas baixas certamente não solicitam altos empréstimos.

```{r Distribuicao LoanDate LoanAmount e Score, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=10}
# Scatterplot da data do empréstimo pelos valores com coloração do score
cc <- scales::seq_gradient_pal('red','green')(seq(0,1, length.out = 11))
ggplot(dff, aes(x = LoanOriginationDate, y = LoanOriginalAmount, color = factor(ProsperScore))) +
  geom_point(alpha = 1/2) +
  scale_x_date(breaks = '1 year', date_labels = '%Y') +
  scale_y_continuous(breaks = seq(0, 35000, 5000)) +
  scale_color_manual(values = cc, na.value = 'dark gray') +
  theme_dark()
```
<br/>Aqui temos um gráfico curioso que mostra o período em que foi implementado o sistema de Score, talvez essa lacuna seja o intervalo necessário para implementar o novo mecanismo. É possível ver um pequeno ajuste do algorítmo em relação as pontuações,os scores mais baixos se concentraram na parte mais baixa.

```{r Distribuicao LoanDate APR e Score, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=10}
# Scatterplot da data do empréstimo pelas taxas com coloração do score
cc <- scales::seq_gradient_pal('red','green')(seq(0,1, length.out = 11))
ggplot(dff, aes(x = LoanOriginationDate, y = BorrowerAPR, color = factor(ProsperScore))) +
  geom_point(alpha = 1/2) +
  scale_x_date(breaks = '1 year', date_labels = '%Y') +
  scale_color_manual(values = cc, na.value = 'dark gray') +
  theme_dark()
```
<br/>Nesse gráfico ficou claro os ajustes do sistema de pontuação. No começo houveram poucas pontuações baixas, com o passar do tempo ele foi ajustando, até mesmo ocorrendo saltos maiores de taxas, um exemplo disso são as linhas horizontais na mesma cor do nível, esse provavelmente foi o período que mais se basearam no score para estimar as taxas. <br/>
Depois o algorítmo ficou mais uniforme, sem grandes saltos, só que ainda assim é evidente que pontuações baixas possuem maiores taxas.

# Análise Multivariada

### Discuta sobre os relacionamentos observados nesta parte da investigação. Quais atributos que fortaleceram os demais na observação das variáveis de interesse?

### Interações surpreendentes e/ou interessantes foram encontradas entre os atributos?

### OPCIONAL: Modelos foram criados usando este conjunto de dados? Discuta sobre os pontos fortes e as limitações do seu modelo.

------

# Gráficos Finais e Sumário

### Primeiro Gráfico
```{r echo=FALSE, Plot_One}

```

### Descrição do Primeiro Gráfico


### Segundo Gráfico
```{r echo=FALSE, Plot_Two}

```

### Descrição do Segundo Gráfico


### Terceiro Gráfico
```{r echo=FALSE, Plot_Three}

```

### Descrição do Terceiro Gráfico

------

# Reflexão


